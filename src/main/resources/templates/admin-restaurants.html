<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{admin-layout :: layout('Admin Restaurants', ~{::section})}">
<section class="space-y-8">
    <div class="card p-6 reveal space-y-4">
        <div>
            <div class="text-sm uppercase tracking-[0.2em] text-ink/60">Restaurant- &amp; Branch-Verwaltung</div>
            <div class="font-display text-2xl">Restaurants verwalten</div>
            <p class="mt-2 text-sm text-ink/60">Suche, bearbeite und erweitere Restaurants und Branches.</p>
        </div>

        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <input id="restaurant-search" class="input md:max-w-sm" placeholder="Suche nach Name oder Code">
            <button class="btn-secondary" type="button" data-toggle="new-restaurant-form">+ Restaurant hinzuf√ºgen</button>
        </div>

        <div class="text-sm text-red-700" th:if="${branchError != null}" th:text="${branchError}">Error</div>

        <form id="new-restaurant-form" class="grid gap-4 md:grid-cols-4 hidden" action="/admin/restaurants/create" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input class="input" name="name" placeholder="Restaurant name" required>
            <input class="input" name="code" placeholder="Code" required>
            <input class="input" name="defaultCurrency" placeholder="Currency (EUR)" value="EUR" required>
            <div class="flex items-center gap-3">
                <label class="text-sm text-ink/60 flex items-center gap-2">
                    <input type="checkbox" name="active" checked>
                    Active
                </label>
                <button class="btn-primary" type="submit">Anlegen</button>
            </div>
        </form>
    </div>

    <div id="restaurant-list" class="space-y-4">
        <div th:each="restaurant : ${restaurants}"
             class="card p-5 reveal space-y-4 restaurant-item"
             th:attr="data-name=${restaurant.name},data-code=${restaurant.code}">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <div>
                    <div class="font-display text-xl" th:text="${restaurant.name}">Restaurant</div>
                    <div class="text-sm text-ink/60">
                        <span th:text="'Code: ' + ${restaurant.code}">Code</span>
                        <span class="mx-2">‚Ä¢</span>
                        <span th:text="'W√§hrung: ' + ${restaurant.defaultCurrency}">Currency</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs uppercase tracking-[0.2em] px-2 py-1 rounded-full"
                          th:text="${restaurant.active ? 'Active' : 'Inactive'}"
                          th:classappend="${restaurant.active ? 'bg-green-100 text-green-700' : 'bg-ink/10 text-ink/60'}">
                        Active
                    </span>
                    <button class="btn-secondary" type="button"
                            th:attr="data-toggle='branches',data-target='branches-' + ${restaurant.id}">
                        Branches anzeigen
                    </button>
                </div>
            </div>

            <div class="flex flex-wrap gap-3">
                <a class="btn-primary"
                   th:href="@{/admin/restaurants/{id}/edit(id=${restaurant.id})}">
                    ‚úèÔ∏è Edit Restaurant
                </a>
                <button class="btn-secondary" type="button"
                        th:attr="data-toggle='branch-form',data-target='branch-form-' + ${restaurant.id},data-branches='branches-' + ${restaurant.id}">
                    ‚ûï Branch hinzuf√ºgen
                </button>
                <form th:action="@{/admin/restaurants/{id}/delete(id=${restaurant.id})}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button class="btn-secondary" type="submit">üóëÔ∏è Restaurant l√∂schen</button>
                </form>
            </div>

            <div th:id="'branches-' + ${restaurant.id}" class="hidden space-y-4">
                <div th:if="${#lists.isEmpty(branchesByRestaurant[restaurant.id])}"
                     class="text-sm text-ink/60">
                    Noch keine Branches f√ºr dieses Restaurant.
                </div>

                <div th:each="branch : ${branchesByRestaurant[restaurant.id]}" class="card p-4 border border-ink/10 space-y-3">
                    <div class="grid gap-3 md:grid-cols-4 md:items-end">
                        <form th:action="@{/admin/branches/{id}/update(id=${branch.id})}"
                              method="post" class="grid gap-3 md:grid-cols-4 md:col-span-3">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <input type="hidden" name="restaurantId" th:value="${restaurant.id}">
                            <div>
                                <label class="text-xs uppercase tracking-[0.2em] text-ink/60">Branch Code</label>
                                <input class="input" name="branchCode" th:value="${branch.branchCode}">
                            </div>
                            <div>
                                <label class="text-xs uppercase tracking-[0.2em] text-ink/60">Name</label>
                                <input class="input" name="name" th:value="${branch.name}">
                            </div>
                            <label class="text-sm text-ink/60 flex items-center gap-2">
                                <input type="checkbox" name="defaultBranch" th:checked="${branch.defaultBranch}">
                                Default
                            </label>
                            <button class="btn-primary" type="submit">Speichern</button>
                        </form>
                        <form th:action="@{/admin/branches/{id}/delete(id=${branch.id})}" method="post" class="md:justify-self-end">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button class="btn-secondary" type="submit">üóëÔ∏è Delete</button>
                        </form>
                    </div>
                </div>

                <form th:id="'branch-form-' + ${restaurant.id}"
                      class="hidden grid gap-3 md:grid-cols-4"
                      th:action="@{/admin/restaurants/{id}/branches(id=${restaurant.id})}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input class="input" name="branchCode" placeholder="Branch code" required>
                    <input class="input" name="name" placeholder="Branch name" required>
                    <label class="text-sm text-ink/60 flex items-center gap-2">
                        <input type="checkbox" name="defaultBranch">
                        Default
                    </label>
                    <button class="btn-secondary" type="submit">Branch anlegen</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('restaurant-search');
        const restaurantItems = Array.from(document.querySelectorAll('.restaurant-item'));
        if (searchInput) {
            searchInput.addEventListener('input', (event) => {
                const term = event.target.value.trim().toLowerCase();
                restaurantItems.forEach((item) => {
                    const name = (item.dataset.name || '').toLowerCase();
                    const code = (item.dataset.code || '').toLowerCase();
                    const matches = name.includes(term) || code.includes(term);
                    item.classList.toggle('hidden', !matches);
                });
            });
        }

        document.querySelectorAll('[data-toggle="new-restaurant-form"]').forEach((button) => {
            button.addEventListener('click', () => {
                const form = document.getElementById('new-restaurant-form');
                if (form) {
                    form.classList.toggle('hidden');
                }
            });
        });

        document.querySelectorAll('[data-toggle="branches"], [data-toggle="branch-form"]').forEach((button) => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');
                if (!targetId) {
                    return;
                }
                const target = document.getElementById(targetId);
                if (target) {
                    target.classList.toggle('hidden');
                }
                const branchesId = button.getAttribute('data-branches');
                if (branchesId) {
                    const branches = document.getElementById(branchesId);
                    if (branches) {
                        branches.classList.remove('hidden');
                    }
                }
            });
        });
    </script>
</section>
</html>
